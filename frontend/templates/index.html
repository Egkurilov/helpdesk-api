<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Helpdesk Test Page</title>
    <style>
        body {
            display: flex;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 10px;
        }
        .half {
            width: 50%;
            padding: 20px;
            border: 1px solid #ccc;
            height: 90vh;
            overflow-y: auto;
        }
        .left { background-color: #f0f8ff; }
        .right { background-color: #f5f5f5; }
        textarea { width: 100%; height: 80px; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th { background-color: #f2f2f2; }
        .chat {
            border: 1px solid #ccc;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .error { color: red; }
    </style>
</head>
<body>
<div class="half left">
    <h2>User Panel</h2>
    <form id="user-login-form">
        <h3>Login</h3>
        Telegram ID: <input type="text" name="telegram_id" required>
        <button type="submit">Login</button>
    </form>
    <form id="user-ticket-form" style="display: none;">
        <h3>Create Ticket</h3>
        Subject: <input type="text" name="subject" required>
        Description: <textarea name="description" required></textarea>
        Source: <input type="text" name="source" value="Web" required>
        <button type="submit">Create</button>
    </form>
    <div id="user-tickets" style="display: none;">
        <h3>Your Tickets</h3>
        <button onclick="fetchUserTickets()">Refresh Tickets</button>
        <table id="user-tickets-table">
            <thead>
            <tr><th>ID</th><th>Subject</th><th>Status</th></tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    <form id="user-message-form" style="display: none;">
        <h3>Send Message</h3>
        Ticket ID: <input type="text" name="ticket_id" required>
        Content: <textarea name="content" required></textarea>
        <button type="submit">Send</button>
    </form>
    <form id="user-close-ticket-form" style="display: none;">
        <h3>Close Ticket</h3>
        Ticket ID: <input type="text" name="ticket_id" required>
        <button type="submit">Close Ticket</button>
    </form>
    <div class="error" id="user-error"></div>
</div>
<div class="half right">
    <h2>Operator Panel</h2>
    <form id="operator-login-form">
        <h3>Login</h3>
        Username: <input type="text" name="username" required>
        Password: <input type="password" name="password" required>
        <button type="submit">Login</button>
    </form>
    <div id="operator-tickets" style="display: none;">
        <h3>All Tickets</h3>
        <button onclick="fetchOperatorTickets()">Refresh Tickets</button>
        <table id="operator-tickets-table">
            <thead>
            <tr><th>ID</th><th>User ID</th><th>Subject</th><th>Status</th></tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    <form id="operator-messages-form" style="display: none;">
        <h3>Ticket Messages</h3>
        Ticket ID: <input type="text" name="ticket_id" required>
        <button type="submit">Load Messages</button>
        <div class="chat" id="operator-chat"></div>
    </form>
    <form id="operator-message-form" style="display: none;">
        <h3>Send Message</h3>
        Ticket ID: <input type="text" name="ticket_id" required>
        Content: <textarea name="content" required></textarea>
        <button type="submit">Send</button>
    </form>
    <form id="operator-close-ticket-form" style="display: none;">
        <h3>Close Ticket</h3>
        Ticket ID: <input type="text" name="ticket_id" required>
        <button type="submit">Close Ticket</button>
    </form>
    <form id="operator-logout-form" style="display: none;">
        <h3>Logout</h3>
        <button type="submit">Logout</button>
    </form>
    <div class="error" id="operator-error"></div>
</div>

<script>
    let userToken = null;
    let operatorToken = null;
    const API_BASE_URL = "http://localhost:8080"; // Go-сервер на 8080

    // User Functions
    document.getElementById("user-login-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        console.log("User login form submitted");
        const formData = new FormData(e.target);
        const telegramId = formData.get("telegram_id");
        console.log("Telegram ID:", telegramId);
        const loginUrl = `${API_BASE_URL}/api/consumers/token/`;
        console.log("Sending login request to:", loginUrl);
        try {
            const response = await fetch(loginUrl, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ telegram_id: telegramId })
            });
            console.log("Login response status:", response.status);
            const data = await handleResponse(response, "user-error");
            if (data && data.access) {
                userToken = data.access;
                console.log("User logged in, token:", userToken);
                toggleUserForms(true);
                fetchUserTickets();
            } else {
                console.log("Login failed, no access token returned");
            }
        } catch (error) {
            console.error("Login network error:", error);
            document.getElementById("user-error").textContent = `Network error: ${error.message}`;
        }
    });

    document.getElementById("user-ticket-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!userToken) {
            document.getElementById("user-error").textContent = "Please login first!";
            return;
        }
        const formData = new FormData(e.target);
        const ticketData = {
            subject: formData.get("subject"),
            description: formData.get("description"),
            source: formData.get("source")
        };
        const response = await fetch(`${API_BASE_URL}/api/tickets/create`, {
            method: "POST",
            headers: {
                "Authorization": `Bearer ${userToken}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify(ticketData)
        });
        const data = await handleResponse(response, "user-error");
        if (data && data.id) {
            fetchUserTickets();
            e.target.reset();
        }
    });

    document.getElementById("user-message-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        console.log("Send Message clicked (User), userToken:", userToken);
        if (!userToken) {
            document.getElementById("user-error").textContent = "Please login first!";
            return;
        }
        const formData = new FormData(e.target);
        const ticketId = formData.get("ticket_id");
        const content = formData.get("content");
        const messageData = {
            sender: "user",
            recipient: "operator",
            content: content
        };
        console.log("Ticket ID:", ticketId);
        console.log("Message content:", content);
        console.log("Request body:", JSON.stringify(messageData));
        if (!ticketId || !content) {
            document.getElementById("user-error").textContent = "Please enter ticket ID and content!";
            return;
        }
        try {
            const response = await fetch(`${API_BASE_URL}/api/tickets/${ticketId}/messages/`, {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${userToken}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(messageData)
            });
            console.log("Response status:", response.status);
            const data = await handleResponse(response, "user-error");
            console.log("Message sent:", data);
            if (data) {
                document.getElementById("user-message-form").reset();
            }
        } catch (error) {
            console.error("Send Message error (User):", error);
            document.getElementById("user-error").textContent = `Error: ${error.message}`;
        }
    });

    document.getElementById("user-close-ticket-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        console.log("Close Ticket clicked (User), userToken:", userToken);
        if (!userToken) {
            document.getElementById("user-error").textContent = "Please login first!";
            return;
        }
        const formData = new FormData(e.target);
        const ticketId = formData.get("ticket_id");
        console.log("Ticket ID:", ticketId);
        if (!ticketId) {
            document.getElementById("user-error").textContent = "Please enter a ticket ID!";
            return;
        }
        try {
            const response = await fetch(`${API_BASE_URL}/api/tickets/${ticketId}/close/`, {
                method: "POST",
                headers: { "Authorization": `Bearer ${userToken}` }
            });
            console.log("Response status:", response.status);
            const data = await handleResponse(response, "user-error");
            console.log("Ticket closed:", data);
            if (data) {
                fetchUserTickets();
                document.getElementById("user-close-ticket-form").reset();
            }
        } catch (error) {
            console.error("Close Ticket error (User):", error);
            document.getElementById("user-error").textContent = `Error: ${error.message}`;
        }
    });

    async function fetchUserTickets() {
        const response = await fetch(`${API_BASE_URL}/api/tickets/`, {
            method: "GET",
            headers: { "Authorization": `Bearer ${userToken}` }
        });
        const data = await handleResponse(response, "user-error");
        if (data) {
            const tbody = document.querySelector("#user-tickets-table tbody");
            tbody.innerHTML = "";
            data.forEach(ticket => {
                const tr = document.createElement("tr");
                tr.innerHTML = `<td>${ticket.id}</td><td>${ticket.subject}</td><td>${ticket.status}</td>`;
                tbody.appendChild(tr);
            });
        }
    }

    // Operator Functions
    document.getElementById("operator-login-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        console.log("Operator login form submitted");
        const formData = new FormData(e.target);
        const loginData = {
            username: formData.get("username"),
            password: formData.get("password")
        };
        const loginUrl = `${API_BASE_URL}/api/token/`;
        console.log("Sending login request to:", loginUrl);
        try {
            const response = await fetch(loginUrl, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(loginData)
            });
            console.log("Login response status:", response.status);
            const data = await handleResponse(response, "operator-error");
            if (data && data.access) {
                operatorToken = data.access;
                console.log("Operator logged in, token:", operatorToken);
                toggleOperatorForms(true);
                fetchOperatorTickets();
            } else {
                console.log("Login failed, no access token returned");
            }
        } catch (error) {
            console.error("Login error:", error);
            document.getElementById("operator-error").textContent = `Network error: ${error.message}`;
        }
    });

    async function fetchOperatorTickets() {
        const response = await fetch(`${API_BASE_URL}/api/tickets/`, {
            method: "GET",
            headers: { "Authorization": `Bearer ${operatorToken}` }
        });
        const data = await handleResponse(response, "operator-error");
        if (data) {
            const tbody = document.querySelector("#operator-tickets-table tbody");
            tbody.innerHTML = "";
            data.forEach(ticket => {
                const tr = document.createElement("tr");
                tr.innerHTML = `<td>${ticket.id}</td><td>${ticket.user_id}</td><td>${ticket.subject}</td><td>${ticket.status}</td>`;
                tbody.appendChild(tr);
            });
        }
    }

    document.getElementById("operator-messages-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        console.log("Load Messages clicked, operatorToken:", operatorToken);
        if (!operatorToken) {
            document.getElementById("operator-error").textContent = "Please login first!";
            return;
        }
        const formData = new FormData(e.target);
        const ticketId = formData.get("ticket_id");
        console.log("Ticket ID:", ticketId);
        if (!ticketId) {
            document.getElementById("operator-error").textContent = "Please enter a ticket ID!";
            return;
        }
        try {
            const response = await fetch(`${API_BASE_URL}/api/tickets/${ticketId}/messages/`, {
                method: "GET",
                headers: { "Authorization": `Bearer ${operatorToken}` }
            });
            console.log("Response status:", response.status);
            const data = await handleResponse(response, "operator-error");
            console.log("Response data:", data);
            if (data) {
                const chat = document.getElementById("operator-chat");
                chat.innerHTML = "";
                data.forEach(msg => {
                    const p = document.createElement("p");
                    p.textContent = `${msg.sender} -> ${msg.recipient}: ${msg.content} (${msg.timestamp})`;
                    chat.appendChild(p);
                });
            }
        } catch (error) {
            console.error("Load Messages error:", error);
            document.getElementById("operator-error").textContent = `Error: ${error.message}`;
        }
    });

    document.getElementById("operator-message-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        console.log("Send Message clicked (Operator), operatorToken:", operatorToken);
        if (!operatorToken) {
            document.getElementById("operator-error").textContent = "Please login first!";
            return;
        }
        const formData = new FormData(e.target);
        const ticketId = formData.get("ticket_id");
        const content = formData.get("content");
        const messageData = {
            sender: "operator",
            recipient: "user",
            content: content
        };
        console.log("Ticket ID:", ticketId);
        console.log("Message content:", content);
        console.log("Request body:", JSON.stringify(messageData));
        if (!ticketId || !content) {
            document.getElementById("operator-error").textContent = "Please enter ticket ID and content!";
            return;
        }
        try {
            const response = await fetch(`${API_BASE_URL}/api/tickets/${ticketId}/messages/`, {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${operatorToken}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(messageData)
            });
            console.log("Response status:", response.status);
            const data = await handleResponse(response, "operator-error");
            console.log("Message sent:", data);
            if (data) {
                document.getElementById("operator-message-form").reset();
            }
        } catch (error) {
            console.error("Send Message error (Operator):", error);
            document.getElementById("operator-error").textContent = `Error: ${error.message}`;
        }
    });

    document.getElementById("operator-close-ticket-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        console.log("Close Ticket clicked (Operator), operatorToken:", operatorToken);
        if (!operatorToken) {
            document.getElementById("operator-error").textContent = "Please login first!";
            return;
        }
        const formData = new FormData(e.target);
        const ticketId = formData.get("ticket_id");
        console.log("Ticket ID:", ticketId);
        console.log("Authorization header:", `Bearer ${operatorToken}`);
        if (!ticketId) {
            document.getElementById("operator-error").textContent = "Please enter a ticket ID!";
            return;
        }
        try {
            const response = await fetch(`${API_BASE_URL}/api/tickets/${ticketId}/close/`, {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${operatorToken}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({})
            });
            console.log("Response status:", response.status);
            const data = await handleResponse(response, "operator-error");
            console.log("Ticket closed:", data);
            if (data) {
                fetchOperatorTickets();
                document.getElementById("operator-close-ticket-form").reset();
            }
        } catch (error) {
            console.error("Close Ticket error (Operator):", error);
            document.getElementById("operator-error").textContent = `Error: ${error.message}`;
        }
    });

    document.getElementById("operator-logout-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        console.log("Logout clicked, operatorToken:", operatorToken);
        if (!operatorToken) return;
        const response = await fetch(`${API_BASE_URL}/api/logout/`, {
            method: "POST",
            headers: { "Authorization": `Bearer ${operatorToken}` }
        });
        const data = await handleResponse(response, "operator-error");
        if (data && data.message) {
            operatorToken = null;
            toggleOperatorForms(false);
        }
    });

    // Helper Functions
    async function handleResponse(response, errorId) {
        const errorDiv = document.getElementById(errorId);
        try {
            const data = await response.json();
            console.log("Response data:", data);
            if (response.ok) {
                errorDiv.textContent = "";
                return data;
            } else {
                errorDiv.textContent = `Error ${response.status}: ${JSON.stringify(data, null, 2)}`;
                return null;
            }
        } catch (error) {
            console.error("Failed to parse response:", error);
            errorDiv.textContent = "Invalid response from server";
            return null;
        }
    }

    function toggleUserForms(show) {
        document.getElementById("user-login-form").style.display = show ? "none" : "block";
        document.getElementById("user-ticket-form").style.display = show ? "block" : "none";
        document.getElementById("user-tickets").style.display = show ? "block" : "none";
        document.getElementById("user-message-form").style.display = show ? "block" : "none";
        document.getElementById("user-close-ticket-form").style.display = show ? "block" : "none";
    }

    function toggleOperatorForms(show) {
        document.getElementById("operator-login-form").style.display = show ? "none" : "block";
        document.getElementById("operator-tickets").style.display = show ? "block" : "none";
        document.getElementById("operator-messages-form").style.display = show ? "block" : "none";
        document.getElementById("operator-message-form").style.display = show ? "block" : "none";
        document.getElementById("operator-close-ticket-form").style.display = show ? "block" : "none";
        document.getElementById("operator-logout-form").style.display = show ? "block" : "none";
    }
</script>
</body>
</html>